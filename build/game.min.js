!function(){var drawBounds=!1;window.Helpers={getObjValues:function(obj){var key,items=obj||{},arr=[];for(key in items)items.hasOwnProperty(key)&&arr.push(items[key]);return arr},getObjKeys:function(obj){var key,items=obj||{},arr=[];for(key in items)items.hasOwnProperty(key)&&arr.push(key);return arr},within:function(value,min,max){return null!=value&&value>=min&&max>=value},withinGrid:function(pos,rows,columns){return pos&&Helpers.within(pos.x,0,columns-1)&&Helpers.within(pos.y,0,rows-1)},setDrawBounds:function(bool){drawBounds=bool},getDrawBounds:function(){return drawBounds},rectCollision:function(rect1,rect2){return rect1.x<rect2.x+rect2.width&&rect1.x+rect1.width>rect2.x&&rect1.y<rect2.y+rect2.height&&rect1.height+rect1.y>rect2.y},blockIndices:function(blocks,blockType){var i,b=blocks||"",t=(blockType||"").slice(0),ind=[];for(i=0;i<b.length;i++)b[i]==t&&ind.push(i);return ind},randomIndex:function(blocks,blockType){var ind=Helpers.blockIndices(blocks,blockType),rnd=Math.floor(Math.random()*ind.length);return ind[rnd]}},Function.prototype.inheritsFrom=function(parentClassOrObject){return parentClassOrObject.constructor==Function?(this.prototype=Object.create(parentClassOrObject.prototype),this.prototype.constructor=this,this.prototype.parent=parentClassOrObject.prototype):(this.prototype=parentClassOrObject,this.prototype.constructor=this,this.prototype.parent=parentClassOrObject.prototype),this}}(),function(){function load(urlOrArr){urlOrArr instanceof Array?urlOrArr.forEach(function(url){_load(url)}):_load(urlOrArr)}function _load(url){if(resourceCache[url])return resourceCache[url];var img=new Image;img.onload=function(){resourceCache[url]=img,isReady()&&readyCallbacks.forEach(function(func){func()})},resourceCache[url]=!1,img.src=url}function get(url){return resourceCache[url]}function isReady(){var ready=!0;for(var k in resourceCache)resourceCache.hasOwnProperty(k)&&!resourceCache[k]&&(ready=!1);return ready}function onReady(func){readyCallbacks.push(func)}var resourceCache={},readyCallbacks=[],context=null,grid={rows:"WSSSGG",nRows:6,nColumns:5},gameOver=!1;window.Resources={load:load,get:get,onReady:onReady,isReady:isReady,setContext:function(ctx){context=ctx},getContext:function(){return context},setGrid:function(rows,nColumns){rows&&(grid.rows=rows,grid.nRows=rows.length),grid.nColumns=nColumns||grid.nColumns},getGrid:function(){return grid},setGameOver:function(over){gameOver=over},isGameOver:function(){return gameOver}}}(),function(){var blockHeight=83,blockWidth=101,Entity=function(sprite,x,y,offsetX,offsetY,bounds){this.x=x,this.y=y,this.checkBounds=!0,this.opacity=1,this.offsetX=offsetX||0,this.offsetY=offsetY||0,this.bounds=bounds,this.sprite=sprite,this.sprite&&(this.img=Resources.get(this.sprite))};Entity.prototype={getImage:function(){return this.img=Resources.get(this.sprite),this.img},render:function(){var img=this.getImage(),ctx=Resources.getContext();ctx.globalAlpha=this.opacity,ctx.drawImage(img,this.x*blockWidth+this.offsetX,this.y*blockHeight+this.offsetY),ctx.globalAlpha=1,Helpers.getDrawBounds()&&this.checkBounds&&this.drawBounds(ctx)},getBounds:function(){var b=this.bounds||{};return{x:this.x*blockWidth+(b.x||0),y:this.y*blockHeight+(b.y||0),width:b.width||blockWidth,height:b.height||blockHeight}},drawBounds:function(ctx){var b=this.getBounds();b&&(ctx.strokeStyle="#ff0000",ctx.strokeRect(b.x,b.y,b.width,b.height))}};var Block=function(type,x,y){Entity.call(this,Block.types[type],x,y),this.type=type,this.checkBounds=!1};Block.inheritsFrom(Entity),Block.types={G:"images/grass-block.png",S:"images/stone-block.png",W:"images/water-block.png"},Block.getSprites=function(){return Helpers.getObjValues(Block.types)};var Player=function(character,x,y){var bounds={x:16,y:blockHeight-30,width:blockWidth-31,height:blockHeight-6};Entity.call(this,Player.characters[character],x,y,0,-10,bounds),this.character=character,this.speed=1.5,this.animating=!1,this.animationTimer=0};Player.inheritsFrom(Entity),Player.getSprites=function(){return Helpers.getObjValues(Player.characters)},Player.characters={boy:"images/char-boy.png","cat-girl":"images/char-cat-girl.png","pink-girl":"images/char-pink-girl.png"},Player.validMoves={left:{x:-1,y:0},right:{x:1,y:0},up:{x:0,y:-1},down:{x:0,y:1}},Player.prototype.move=function(moves){if(!moves||0===moves.length)return void(this.movement=!1);this.movement={x:0,y:0};for(var move in moves){var item=Player.validMoves[moves[move]];item&&(this.movement.x+=item.x,this.movement.y+=item.y)}},Player.prototype.stop=function(){this.movement=!1},Player.prototype.update=function(dt){var movement=this.movement;if(!this.animating&&movement){var distance=this.speed*dt,newX=this.x+movement.x*distance,newY=this.y+movement.y*distance,grid=Resources.getGrid();Helpers.withinGrid({x:newX,y:newY},grid.nRows,grid.nColumns)&&(this.x=newX,this.y=newY)}this.dead?this.deathAnimation(dt):this.goal&&this.goalAnimation(dt)},Player.prototype.deathAnimation=function(dt){this.animationTimer-=dt,this.animationTime+=5*dt,this.animationTimer<=0?(this.setDead(!1,!Resources.isGameOver()),"function"==typeof this.deathCallback&&this.deathCallback()):this.opacity=Math.abs(Math.sin(1-this.animationTime))},Player.prototype.goalAnimation=function(dt){this.animationTimer-=dt,this.animationTime+=5*dt,this.animationTimer<=0?this.setGoal(!1,!0):this.opacity=Math.abs(Math.sin(1-this.animationTime))},Player.prototype.reset=function(){this.opacity=1;var grid=Resources.getGrid(),xPos=Math.floor(Math.random()*grid.nColumns);this.x=xPos,this.y=Helpers.randomIndex(grid.rows,"G")},Player.prototype.setDead=function(dead,reset){this.dead=dead,this.setAnimating(dead,2),this.opacity=1,reset&&this.reset()},Player.prototype.setAnimating=function(animate,time){this.animating=animate,this.animationTimer=animate?time:0,this.animationTime=0},Player.prototype.setGoal=function(goal,reset){this.goal=goal,this.setAnimating(goal,2),reset&&this.reset()};var Enemy=function(x,y,speed){var bounds={x:2,y:blockHeight-26,width:blockWidth-4,height:blockHeight-16};Entity.call(this,Enemy.sprite,x,y,0,-20,bounds),this.speed=speed};Enemy.inheritsFrom(Entity),Enemy.sprite="images/enemy-bug.png",Enemy.prototype.update=function(dt){this.x+=this.speed*dt},Enemy.prototype.reset=function(){this.x=-1,this.y=Helpers.randomIndex(Resources.getGrid().rows,"S"),this.speed=1+2*Math.random()};var Heart=function(x){Entity.call(this,Heart.sprite,x,0,0,-25)};Heart.sprite="images/Heart.png",Heart.prototype.render=function(){var ctx=Resources.getContext();ctx.save(),ctx.scale(.4,.4),ctx.globalAlpha=this.opacity,ctx.drawImage(this.img,this.x*blockWidth+this.offsetX,this.y*blockHeight+this.offsetY),ctx.restore()},window.Player=Player,window.Block=Block,window.Enemy=Enemy,window.Heart=Heart}(),function(){function main(){var now=Date.now(),dt=(now-lastTime)/1e3;paused||update(dt),render(),lastTime=now,win.requestAnimationFrame(main)}function init(){reset(),initEntities(),lastTime=Date.now(),main()}function update(dt){if(updateEntities(dt),!Resources.isGameOver()){var ok=checkCollisions();ok&&checkPowerUps()}}function updateEntities(dt){var nColumns=Resources.getGrid().nColumns;allEnemies.forEach(function(enemy){enemy.update(dt),enemy.x>=nColumns&&enemy.reset()}),player.update(dt)}function checkCollisions(){if(player.dead)return!1;var rect1=player.getBounds();return allEnemies.forEach(function(enemy){var rect2=enemy.getBounds();return Helpers.rectCollision(rect1,rect2)?(score=0,lives--,Resources.setGameOver(0===lives),void player.setDead(!0)):void 0}),!player.dead}function checkPowerUps(){if(!player.animating){var ind=Helpers.blockIndices(Resources.getGrid().rows,"W"),y=Math.round(player.y+.4);ind.indexOf(y)>-1&&(player.y=y,score++,player.setGoal(!0))}}function render(){var i,heart;for(ctx.clearRect(0,0,canvas.width,canvas.height),blocks.forEach(function(block){block.render()}),i=0;i<allLives.length;i++)heart=allLives[i],heart.opacity=i>=lives?.4:1,heart.render();renderEntities(),renderScore(),Resources.isGameOver()&&renderGameOver()}function renderEntities(){allEnemies.forEach(function(enemy){enemy.render()}),player.render()}function reset(){Resources.setGameOver(!1),paused=!1,score=0,lives=3,pressedKeys={left:!1,right:!1,up:!1,down:!1}}function loadResources(){var images=[];images=images.concat(Player.getSprites()),images=images.concat(Block.getSprites()),images.push(Enemy.sprite),images.push(Heart.sprite),Resources.load(images),Resources.onReady(init)}function initEntities(){allEnemies=[],allLives=[],blocks=[],initBlocks(),initPlayer(),initEnemies(),initHearts()}function initPlayer(){var characters=Helpers.getObjKeys(Player.characters),charInd=Math.floor(Math.random()*characters.length);player=new Player(characters[charInd]),player.reset(),player.deathCallback=function(){Resources.isGameOver()&&(paused=!0)}}function initEnemies(){var i;for(i=0;3>i;i++){var enemy=new Enemy;enemy.reset(),allEnemies.push(enemy)}}function initBlocks(){var row,col,grid=Resources.getGrid(),nRows=grid.nRows,nColumns=grid.nColumns;for(row=0;nRows>row;row++)for(col=0;nColumns>col;col++)blocks.push(new Block(grid.rows[row],col,row))}function initHearts(){var i;for(i=0;3>i;i++){var heart=new Heart(i);allLives.push(heart)}}function movePlayer(){if(player&&!paused){var moves=[];for(var key in pressedKeys)pressedKeys.hasOwnProperty(key)&&pressedKeys[key]&&moves.push(key);player.move(moves)}}function renderScore(){ctx.save(),ctx.font="25px Exo",ctx.textAlign="right",ctx.strokeStyle="#00f",ctx.strokeText("Score: "+score,canvas.width-10,30),ctx.fillStyle="#333",ctx.fillText("Score: "+score,canvas.width-10,30),ctx.restore()}function renderGameOver(){ctx.save(),ctx.font="48px Exo",ctx.textAlign="center";var w2=canvas.width/2,h2=canvas.height/2;ctx.strokeStyle="#333",ctx.lineWidth=8,ctx.strokeText("GAME OVER",w2,h2),ctx.fillStyle="#eee",ctx.fillText("GAME OVER",w2,h2),ctx.font="20px Exo",ctx.lineWidth=4,ctx.strokeStyle="#333",ctx.strokeText("Press ESC for New Game",w2,h2+50),ctx.fillStyle="#fff",ctx.fillText("Press ESC for New Game",w2,h2+50),ctx.restore()}var lastTime,paused,score,lives,doc=document,win=window,canvas=doc.createElement("canvas"),ctx=canvas.getContext("2d"),player=null,allEnemies=[],allLives=[],blocks=[];Resources.setContext(ctx),canvas.width=505,canvas.height=606,doc.body.appendChild(canvas);var movementKeys={37:"left",38:"up",39:"right",40:"down"},pressedKeys={left:!1,right:!1,up:!1,down:!1};doc.addEventListener("keyup",function(e){var move=movementKeys[e.keyCode];switch(move&&(pressedKeys[move]=!1,movePlayer()),e.keyCode){case 27:Resources.isGameOver()?init():paused=!paused}}),doc.addEventListener("keydown",function(e){var move=movementKeys[e.keyCode];move&&(pressedKeys[move]=!0,movePlayer())}),window.Engine={init:function(opts){var o=opts||{};o.grid&&Resources.setGrid(o.grid.rows,o.grid.nColumns),loadResources()}}}(),Helpers.setDrawBounds(!1),Engine.init({grid:{rows:"WSGSGS"}});