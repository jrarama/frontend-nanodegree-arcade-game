!function(){var drawBounds=!1;window.Helpers={getObjValues:function(obj){var key,items=obj||{},arr=[];for(key in items)items.hasOwnProperty(key)&&arr.push(items[key]);return arr},getObjKeys:function(obj){var key,items=obj||{},arr=[];for(key in items)items.hasOwnProperty(key)&&arr.push(key);return arr},within:function(value,min,max){return null!=value&&value>=min&&max>=value},withinGrid:function(pos,rows,columns){return pos&&Helpers.within(pos.x,0,columns-1)&&Helpers.within(pos.y,0,rows-1)},setDrawBounds:function(bool){drawBounds=bool},getDrawBounds:function(){return drawBounds},rectCollision:function(rect1,rect2){return rect1.x<rect2.x+rect2.width&&rect1.x+rect1.width>rect2.x&&rect1.y<rect2.y+rect2.height&&rect1.height+rect1.y>rect2.y},blockIndices:function(blocks,blockType){var i,b=blocks||"",t=(blockType||"").slice(0),ind=[];for(i=0;i<b.length;i++)b[i]==t&&ind.push(i);return ind},randomItem:function(array){var rnd=Math.floor(Math.random()*array.length);return array[rnd]},randomIndex:function(blocks,blockType){var ind=Helpers.blockIndices(blocks,blockType),rnd=Math.floor(Math.random()*ind.length);return ind[rnd]},shuffleArray:function(array){for(var temporaryValue,randomIndex,currentIndex=array.length;0!==currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),currentIndex-=1,temporaryValue=array[currentIndex],array[currentIndex]=array[randomIndex],array[randomIndex]=temporaryValue;return array}},Function.prototype.inheritsFrom=function(parentClassOrObject){return parentClassOrObject.constructor==Function?(this.prototype=Object.create(parentClassOrObject.prototype),this.prototype.constructor=this,this.prototype.parent=parentClassOrObject.prototype):(this.prototype=parentClassOrObject,this.prototype.constructor=this,this.prototype.parent=parentClassOrObject.prototype),this}}(),function(){function load(urlOrArr){urlOrArr instanceof Array?urlOrArr.forEach(function(url){_load(url)}):_load(urlOrArr)}function _load(url){if(resourceCache[url])return resourceCache[url];var img=new Image;img.onload=function(){resourceCache[url]=img,isReady()&&readyCallbacks.forEach(function(func){func()})},resourceCache[url]=!1,img.src=url}function get(url){return resourceCache[url]}function isReady(){var ready=!0;for(var k in resourceCache)resourceCache.hasOwnProperty(k)&&!resourceCache[k]&&(ready=!1);return ready}function onReady(func){readyCallbacks.push(func)}var resourceCache={},readyCallbacks=[],context=null,grid={rows:"WSSSGG",nRows:6,nColumns:5},gameOver=!1;window.Resources={load:load,get:get,onReady:onReady,isReady:isReady,setContext:function(ctx){context=ctx},getContext:function(){return context},setGrid:function(rows,nColumns){rows&&(grid.rows=rows,grid.nRows=rows.length),grid.nColumns=nColumns||grid.nColumns},getGrid:function(){return grid},setGameOver:function(over){gameOver=over},isGameOver:function(){return gameOver}}}(),function(){var blockHeight=83,blockWidth=101,Entity=function(sprite,x,y,offsetX,offsetY,bounds){this.x=x,this.y=y,this.checkBounds=!0,this.opacity=1,this.scale=1,this.offsetX=offsetX||0,this.offsetY=offsetY||0,this.translate={x:0,y:0},this.bounds=bounds,this.sprite=sprite,this.sprite&&(this.img=Resources.get(this.sprite))};Entity.prototype={getImage:function(){return this.img=Resources.get(this.sprite),this.img},render:function(){var img=this.getImage(),ctx=Resources.getContext();ctx.save(),ctx.globalAlpha=this.opacity,(0!==this.translate||0!==this.translate)&&ctx.translate(this.translate.x,this.translate.y);var x=this.x*blockWidth+this.offsetX,y=this.y*blockHeight+this.offsetY;ctx.drawImage(img,x,y,img.width*this.scale,img.height*this.scale),ctx.globalAlpha=1,ctx.restore(),Helpers.getDrawBounds()&&this.checkBounds&&this.drawBounds(ctx)},getBounds:function(){var b=this.bounds||{};return{x:this.x*blockWidth+(b.x||0),y:this.y*blockHeight+(b.y||0),width:b.width||blockWidth,height:b.height||blockHeight}},drawBounds:function(ctx){var b=this.getBounds();b&&(ctx.strokeStyle="#ff0000",ctx.strokeRect(b.x,b.y,b.width,b.height))}};var Block=function(type,x,y){Entity.call(this,Block.types[type],x,y),this.type=type,this.checkBounds=!1};Block.inheritsFrom(Entity),Block.types={G:"images/grass-block.png",S:"images/stone-block.png",W:"images/water-block.png"},Block.getSprites=function(){return Helpers.getObjValues(Block.types)};var Player=function(character,x,y){var bounds={x:16,y:blockHeight-30,width:blockWidth-31,height:blockHeight-6};Entity.call(this,Player.characters[character],x,y,0,-10,bounds),this.character=character,this.speed=1.5,this.animating=!1,this.animationTimer=0};Player.inheritsFrom(Entity),Player.getSprites=function(){return Helpers.getObjValues(Player.characters)},Player.characters={boy:"images/char-boy.png","cat-girl":"images/char-cat-girl.png","pink-girl":"images/char-pink-girl.png"},Player.validMoves={left:{x:-1,y:0},right:{x:1,y:0},up:{x:0,y:-1},down:{x:0,y:1}},Player.prototype.move=function(moves){if(!moves||0===moves.length)return void(this.movement=!1);this.movement={x:0,y:0};for(var move in moves){var item=Player.validMoves[moves[move]];item&&(this.movement.x+=item.x,this.movement.y+=item.y)}},Player.prototype.stop=function(){this.movement=!1},Player.prototype.update=function(dt){var movement=this.movement;if(!this.animating&&movement){var distance=this.speed*dt,newX=this.x+movement.x*distance,newY=this.y+movement.y*distance,grid=Resources.getGrid();Helpers.withinGrid({x:newX,y:newY},grid.nRows,grid.nColumns)&&(this.x=newX,this.y=newY)}this.dead?this.deathAnimation(dt):this.goal&&this.goalAnimation(dt)},Player.prototype.deathAnimation=function(dt){this.animationTimer-=dt,this.animationTime+=5*dt,this.animationTimer<=0?(this.setDead(!1,!Resources.isGameOver()),"function"==typeof this.deathCallback&&this.deathCallback()):this.opacity=Math.abs(Math.sin(1-this.animationTime))},Player.prototype.goalAnimation=function(dt){this.animationTimer-=dt,this.animationTime+=5*dt,this.animationTimer<=0?(this.setGoal(!1,!0),"function"==typeof this.goalCallback&&this.goalCallback()):this.translate.y=-15*Math.abs(Math.sin(this.animationTime))},Player.prototype.reset=function(){this.opacity=1,this.translate={x:0,y:0};var grid=Resources.getGrid(),xPos=Math.floor(Math.random()*grid.nColumns);this.x=xPos,this.y=Helpers.randomIndex(grid.rows,"G")},Player.prototype.setDead=function(dead,reset){this.dead=dead,this.setAnimating(dead,2),this.opacity=1,reset&&this.reset()},Player.prototype.setAnimating=function(animate,time){this.animating=animate,this.animationTimer=animate?time:0,this.animationTime=0},Player.prototype.setGoal=function(goal,reset){this.goal=goal,this.setAnimating(goal,2),reset&&this.reset()};var Enemy=function(maxSpeed,x,y){var bounds={x:2,y:blockHeight-26,width:blockWidth-4,height:blockHeight-16};Entity.call(this,Enemy.sprite,x,y,0,-20,bounds),this.maxSpeed=maxSpeed||2.5,this.speed=maxSpeed};Enemy.inheritsFrom(Entity),Enemy.sprite="images/enemy-bug.png",Enemy.prototype.update=function(dt){this.x+=this.speed*dt},Enemy.prototype.reset=function(){this.x=-1,this.y=Helpers.randomIndex(Resources.getGrid().rows,"S"),this.speed=1+Math.random()*(this.maxSpeed-1)};var Heart=function(x){Entity.call(this,Heart.sprite,x,0,-55*x,-15),this.scale=.4,this.checkBounds=!1};Heart.sprite="images/heart.png",Heart.inheritsFrom(Entity);var Collectible=function(sprites,offsetX,offsetY,bounds){var grid=Resources.getGrid(),sprite=sprites;sprites instanceof Array&&(sprite=Helpers.randomItem(sprites));var y=Helpers.randomIndex(grid.rows,"S"),x=Math.floor(Math.random()*grid.nColumns);Entity.call(this,sprite,x,y,offsetX,offsetY,bounds)};Collectible.inheritsFrom(Entity);var Gem=function(){var bounds={x:13,y:blockHeight-30,width:blockWidth-27,height:blockHeight-6};Collectible.call(this,Gem.getSprites(),12,9,bounds),this.scale=.75};Gem.inheritsFrom(Collectible),Gem.types={blue:"images/gem-blue.png",green:"images/gem-green.png",orange:"images/gem-orange.png"},Gem.getSprites=function(){return Helpers.getObjValues(Gem.types)};var Star=function(){var bounds={x:13,y:blockHeight-25,width:blockWidth-27,height:blockHeight-16};Collectible.call(this,Star.sprite,0,-10,bounds)};Star.sprite="images/star.png",Star.inheritsFrom(Collectible);var Key=function(){var bounds={x:30,y:blockHeight-30,width:blockWidth-60,height:blockHeight-6};Collectible.call(this,Key.sprite,4,2,bounds),this.scale=.9};Key.sprite="images/key.png",Key.inheritsFrom(Collectible),window.Player=Player,window.Block=Block,window.Enemy=Enemy,window.Heart=Heart,window.Gem=Gem,window.Star=Star,window.Key=Key}(),function(){function newGridRows(){var rows=Helpers.shuffleArray("SSSGG".split("")).join("");rows=Helpers.shuffleArray(["W",rows]).join(""),Resources.setGrid(rows)}function generateLevel(lvl){collectibles={key:lvl%7===0,life:lvl%5===0,gem:lvl%2===0}}function main(){var now=Date.now(),dt=(now-lastTime)/1e3;paused||update(dt),render(),lastTime=now,win.requestAnimationFrame(main)}function init(){reset(),initLevel(),lastTime=Date.now(),main()}function update(dt){if(updateEntities(dt),!Resources.isGameOver()){var ok=checkCollisions();ok&&checkPowerUps()}}function updateEntities(dt){var nColumns=Resources.getGrid().nColumns;allEnemies.forEach(function(enemy){enemy.update(dt),enemy.x>=nColumns&&enemy.reset()}),player.update(dt)}function checkCollisions(){if(player.dead)return!1;var rect1=player.getBounds();return allEnemies.forEach(function(enemy){var rect2=enemy.getBounds();return Helpers.rectCollision(rect1,rect2)?(lives--,Resources.setGameOver(0===lives),void player.setDead(!0)):void 0}),!player.dead}function checkGoal(){var ind=Helpers.blockIndices(Resources.getGrid().rows,"W"),y=Math.round(player.y+.4);ind.indexOf(y)>-1&&(player.y=y,score++,player.setGoal(!0))}function checkPowerUps(){if(!player.animating){checkGoal();var rect2=null,rect1=player.getBounds();collectibles.gem&&(rect2=collectibles.gem.getBounds(),Helpers.rectCollision(rect1,rect2)&&(score+=1,collectibles.gem=!1)),collectibles.life&&(rect2=collectibles.life.getBounds(),Helpers.rectCollision(rect1,rect2)&&(lives++,lives>3&&(lives=3),score+=2,collectibles.life=!1)),collectibles.key&&(rect2=collectibles.key.getBounds(),Helpers.rectCollision(rect1,rect2)&&(changeRows=!0,score+=3,collectibles.key=!1))}}function render(){var i,heart;for(ctx.fillStyle="#fff",ctx.fillRect(0,0,canvas.width,canvas.height),blocks.forEach(function(block){block.render()}),i=0;i<allLives.length;i++)heart=allLives[i],heart.opacity=i>=lives?.4:1,heart.render();renderCollectibles(),renderEntities(),renderScore(),renderLevel(),Resources.isGameOver()&&renderGameOver()}function renderEntities(){allEnemies.forEach(function(enemy){enemy.render()}),player.render()}function renderCollectibles(){collectibles.key&&collectibles.key.render(),collectibles.life&&collectibles.life.render(),collectibles.gem&&collectibles.gem.render()}function reset(){generateLevel(0),Resources.setGameOver(!1),paused=!1,score=0,lives=3,level=1,changeRows=!1,pressedKeys={left:!1,right:!1,up:!1,down:!1}}function loadResources(){var images=[];images=images.concat(Player.getSprites()),images=images.concat(Block.getSprites()),images=images.concat(Gem.getSprites()),images.push(Enemy.sprite),images.push(Heart.sprite),images.push(Star.sprite),images.push(Key.sprite),Resources.load(images),Resources.onReady(init)}function initEntities(){allEnemies=[],allLives=[],blocks=[],initBlocks(),initPlayer(),initEnemies(),initHearts()}function initLevel(){changeRows&&(newGridRows(),changeRows=!1),generateLevel(level),initCollectibles(),initEntities()}function initCollectibles(){collectibles.key===!0&&(collectibles.key=new Key),collectibles.life===!0&&(collectibles.life=new Star),collectibles.gem===!0&&(collectibles.gem=new Gem)}function initPlayer(){var characters=Helpers.getObjKeys(Player.characters),charInd=Math.floor(Math.random()*characters.length);player=new Player(characters[charInd]),player.reset(),player.deathCallback=function(){Resources.isGameOver()&&(paused=!0)},player.goalCallback=function(){++level,initLevel()}}function initEnemies(){var i;for(i=0;3>i;i++){var enemy=new Enemy;enemy.reset(),allEnemies.push(enemy)}}function initBlocks(){var row,col,grid=Resources.getGrid(),nRows=grid.nRows,nColumns=grid.nColumns;for(row=0;nRows>row;row++)for(col=0;nColumns>col;col++)blocks.push(new Block(grid.rows[row],col,row))}function initHearts(){var i;for(i=0;3>i;i++){var heart=new Heart(i);allLives.push(heart)}}function movePlayer(){if(player&&!paused){var moves=[];for(var key in pressedKeys)pressedKeys.hasOwnProperty(key)&&pressedKeys[key]&&moves.push(key);player.move(moves)}}function renderScore(){ctx.save(),ctx.font="25px Exo",ctx.textAlign="right",ctx.strokeStyle="#00f",ctx.strokeText("Score: "+score,canvas.width-10,30),ctx.fillStyle="#333",ctx.fillText("Score: "+score,canvas.width-10,30),ctx.restore()}function renderLevel(){ctx.save(),ctx.font="25px Exo",ctx.textAlign="center",ctx.strokeStyle="#00f",ctx.strokeText("Level "+level,canvas.width/2,30),ctx.fillStyle="#333",ctx.fillText("Level "+level,canvas.width/2,30),ctx.restore()}function renderGameOver(){ctx.save(),ctx.font="48px Exo",ctx.textAlign="center";var w2=canvas.width/2,h2=canvas.height/2;ctx.strokeStyle="#333",ctx.lineWidth=8,ctx.strokeText("GAME OVER",w2,h2),ctx.fillStyle="#eee",ctx.fillText("GAME OVER",w2,h2),ctx.font="20px Exo",ctx.lineWidth=4,ctx.strokeStyle="#333",ctx.strokeText("Press ESC for New Game",w2,h2+50),ctx.fillStyle="#fff",ctx.fillText("Press ESC for New Game",w2,h2+50),ctx.restore()}var lastTime,paused,score,level,changeRows,lives,doc=document,win=window,canvas=doc.createElement("canvas"),ctx=canvas.getContext("2d"),player=null,allEnemies=[],allLives=[],blocks=[];Resources.setContext(ctx),canvas.width=505,canvas.height=606,doc.body.appendChild(canvas);var movementKeys={37:"left",38:"up",39:"right",40:"down"},pressedKeys={left:!1,right:!1,up:!1,down:!1},collectibles={key:!1,gem:!1,life:!1};doc.addEventListener("keyup",function(e){var move=movementKeys[e.keyCode];switch(move&&(pressedKeys[move]=!1,movePlayer()),e.keyCode){case 27:Resources.isGameOver()?init():paused=!paused}}),doc.addEventListener("keydown",function(e){var move=movementKeys[e.keyCode];move&&(pressedKeys[move]=!0,movePlayer())}),window.Engine={init:function(opts){var o=opts||{};o.grid&&Resources.setGrid(o.grid.rows,o.grid.nColumns),loadResources()}}}(),Helpers.setDrawBounds(!1),Engine.init();